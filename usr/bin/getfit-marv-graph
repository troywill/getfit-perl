#!/usr/bin/env perl
use warnings;
use strict;
use PDF::API3::Compat::API2;
use PDF::API3::Compat::API2::Util;
use lib '/usr/lib/perl5';
use Getfit::ConfigReader::Simple;
use Getfit::Statistics;

my $XMAX = 792;
my $YMAX = 612;

my $font_height = 8;
my $spacer = 2;

## Graph Constants
my $MIN_WEIGHT=250;
my $MAX_WEIGHT=300;
my $MIN_TIME = 1277311380;
my $MAX_TIME = 1277404964;
$MAX_TIME = time;

my $LEFT = 20;
my $RIGHT = $XMAX - 20;
my $UPPER_RECT = $YMAX - 20;
my $LOWER_RECT = 80;

# Circle Constants
my $RADIUS = 2;

my $pdf=PDF::API3::Compat::API2->new;
my $font=$pdf->corefont('Verdana');
my $page = $pdf->page;
$page->mediabox(792,612); # Letter Landscape
my $gfx=$page->gfx;

################# Text ##########
my $TEXT_LEFT = 40;
my $TEXT_TOP = $LOWER_RECT - 18;

$gfx->textlabel($TEXT_LEFT,$TEXT_TOP,$font,$font_height,"Marv Redshaw");
my $current_goal = sprintf( "%.2f", $Marv::Statistics::Current_goal);
$gfx->textlabel($TEXT_LEFT,($TEXT_TOP-$font_height),$font,$font_height,  "Current Goal: $current_goal");
# $gfx->textlabel($TEXT_LEFT,($TEXT_TOP-$font_height),$font,$font_height,  "Beginning Unix Time: ");
$gfx->textlabel($TEXT_LEFT,($TEXT_TOP-2*$font_height),$font,$font_height,"Beginning Weight: 295");
chomp( my $date = `date` );
my $string = 'Current Unix Time: ' . time . " ($date)";
$gfx->textlabel($TEXT_LEFT,($TEXT_TOP-3*$font_height),$font,$font_height,$string);
$gfx->textlabel($TEXT_LEFT,($TEXT_TOP-4*$font_height),$font,$font_height,"Current Weight: $current_goal");

# $gfx->stokecolor('lightblue');
&plot_start_weight;
&plot_weight02;
&draw_rectangle;
&draw_weight_line;
&draw_goal_line;

$pdf->saveas("/srv/http/pdf/marv.pdf");
$pdf->end();

sub calculate_plot_point {
    my ( $weight, $time ) = @_;
    my ( $xscale, $yscale ) = &scale;
    my $x = $LEFT + $xscale * ( $time - $MIN_TIME );
    my $y = $LOWER_RECT + $yscale * ( $weight - $MIN_WEIGHT );
    return ( $x, $y );
}

sub scale {
    my $points_per_pound =  ( $UPPER_RECT - $LOWER_RECT ) / ( $MAX_WEIGHT - $MIN_WEIGHT );
    my $points_per_second = ( $RIGHT - $LEFT ) / ( $MAX_TIME - $MIN_TIME );
    return ( $points_per_second, $points_per_pound );
}

sub plot_start_weight {
    my ( $x, $y ) = &calculate_plot_point ( 295.0, 1277311380 );
    $gfx->circle($x,$y,$RADIUS);
}

sub plot_weight02 {
    my ( $x, $y ) = &calculate_plot_point ( 297.8, 1277404964 );
    $gfx->circle($x,$y,$RADIUS);
    ( $x, $y ) = &calculate_plot_point ( 299.8, 1277482286 );
    $gfx->circle($x,$y,$RADIUS);
    ( $x, $y ) = &calculate_plot_point ( 298.8, 1277750270 );
    $gfx->circle($x,$y,$RADIUS);
}

sub draw_rectangle {
    my @origin = ( $LEFT, $UPPER_RECT );
    $gfx->move($origin[0],$origin[1]);
    $gfx->line($RIGHT, $UPPER_RECT);
    $gfx->line($RIGHT,$LOWER_RECT);
    $gfx->line($LEFT, $LOWER_RECT);
    $gfx->line($LEFT, $UPPER_RECT);
    $gfx->stroke;
}

sub draw_weight_line {
    my ( $x1, $y1 ) = &calculate_plot_point ( 295.0, 1277311380 );
    my ( $x2, $y2 ) = &calculate_plot_point ( 297.8, 1277404964 );
    $gfx->move($x1,$y1);
    $gfx->line($x2,$y2);
    my ( $x, $y ) = &calculate_plot_point ( 299.8, 1277482286 );
    $gfx->line($x,$y);
    $gfx->stroke;
}

sub draw_goal_line {
    my $time = time;
    my ( $x1, $y1 ) = &calculate_plot_point ( 295.0, 1277311380 );
    $gfx->move($x1,$y1);

    my $goal_weight = 295 - ( 1277404964 - 1277311380 ) * ( 945 / 3500 / 86400 );
    my ( $x2, $y2 ) = &calculate_plot_point ( $goal_weight, 1277404964 );
    $gfx->line($x2,$y2);

    $goal_weight = $goal_weight - ( time - 1277404964 ) * ( 35 / 3500 / 86400 );  
    my ( $x3, $y3 ) = &calculate_plot_point ( $goal_weight, $time );
    $gfx->line($x3,$y3);
    
    $gfx->stroke;
}

exit;
